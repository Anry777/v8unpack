# Direct 1C Export – текущий статус

Дата: 2026-02-04

## Кратко
Сделан прямой экспорт из `Автомир.cfe` в структуру выгрузки 1С **без JSON‑промежутков**. Реализована ветка `--format 1c`, которая читает CFE и сразу пишет XML/BSL в выходную папку.

## Что сделано

### 1) Новый direct‑1C контур
Добавлен пакет `src/v8unpack/direct_1c`:
- `decoder.py` — основной проход по контейнеру, без JSON
- `catalogs.py` — экспорт каталогов в XML + Forms
- `forms.py` — экспорт описания форм + попытка вытащить модуль формы
- `types.py` — построение карт типов (Catalog/Document/DefinedType) **без JSON**
- `__init__.py` — экспортирует `extract_1c_direct`

### 2) Подключение в CLI
`src/v8unpack/v8unpack.py`:
- при `--format 1c` теперь используется `extract_1c_direct`, JSON‑путь не вызывается

### 3) Исправления
- `src/v8unpack/format_1c/common.py` — исправлена строка `_XML_HEADER`
- `src/v8unpack/format_1c/catalogs.py` — корректное имя файла `Предустановленные данные.bin`

### 4) Экспорт Catalogs (1 в 1 по структуре)
Генерируется структура как в выгрузке 1С:
- `Catalogs/<Каталог>.xml`
- `Catalogs/<Каталог>/Forms/<Форма>.xml`
- `Catalogs/<Каталог>/Forms/<Форма>/Ext/Form/Module.bsl` (если модуль вытягивается)

Также в `Catalogs/<Каталог>.xml` включаются:
- реквизиты (attributes)
- команды (commands)
- флаг предопределённых данных

### 5) Формы
Для формы создаётся:
- `<Форма>.xml` (метаданные формы)
- `Ext/Form/Module.bsl` (если удаётся достать модуль формы)
- попытка найти и скопировать raw `Ext/Form.xml` напрямую из контейнера (если в бинарнике уже хранится готовый XML)

## Что НЕ сделано / текущие расхождения

Сравнение `Автомир_1c\Catalogs\ДоговорыКонтрагентов` vs `Автомир_from_zip\Catalogs\ДоговорыКонтрагентов`:
- отсутствуют:
  - `Forms\ФормаЭлемента\Ext\Form.xml`
  - `Forms\ФормаЭлемента\Ext\Form\Module.bsl`  (после последней правки всё ещё не появилось)

Глобально по Catalogs:
- отсутствуют все `Ext/Form.xml` форм
- отсутствуют многие `Ext/Form/Module.bsl`
- отсутствует `Организации\Ext\Predefined.xml`
- есть отличия по размеру `*.xml` (каталоги и формы)

## Почему так
1. `Form.xml` в выгрузке 1С — это **отдельный XML logform**, которого нет готовым в CFE (нужно строить из данных формы). Сейчас мы его не генерируем.
2. Модуль формы хранится внутри form‑данных, но текущий вызов `decode_includes()` недостаточен для получения `code['obj']` — надо разбирать форму глубже.
3. `Predefined.xml` требует парсинга бинарного файла `<uuid>.1c` (predefined data), конвертация пока не реализована.

## TODO (следующие шаги)

1. **Form.xml (logform) генерация**
   - Реализовать отдельный конвертер из form‑структуры в logform XML.
   - Источник: `MetaDataObject/Form/*` уже умеет разбирать форму в структуру (`elements_tree`, `props`, `commands`).
   - Нужно сериализовать это в XML формата `http://v8.1c.ru/8.3/xcf/logform`.

2. **Модули форм (Module.bsl)**
   - Выяснить, где именно лежит код модуля формы в контейнере и как его корректно извлекать.
   - Сейчас `decode_includes()` не всегда заполняет `code['obj']`.
   - Проверить: для Form типа `1`/`0` используются разные места хранения кода.

3. **Predefined.xml**
   - Реализовать парсер `<uuid>.1c` и генерацию `Ext/Predefined.xml`.
   - В выгрузке 1С это `xcf/predef`.

4. **Сверка 1‑в‑1**
   - После генерации `Form.xml` и `Module.bsl` пересверить `Catalogs` и зафиксировать абсолютное совпадение.

## Полезные команды

Запуск:
```
.venv\Scripts\python -m v8unpack -E C:\Repositories\v8unpack\Автомир.cfe C:\Repositories\v8unpack\Автомир_1c --format 1c
```

Проверка папок:
- `C:\Repositories\v8unpack\Автомир_1c\Catalogs\...`
- `C:\Repositories\v8unpack\Автомир_from_zip\Catalogs\...`

---

Если нужно, могу продолжить с генерацией Form.xml и парсингом Predefined.xml.
